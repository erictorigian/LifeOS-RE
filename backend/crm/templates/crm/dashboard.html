{% extends "crm/base.html" %}
{% block title %}Dashboard - CRM{% endblock %}

{% block content %}
<!-- Header -->
<div style="margin-bottom: 40px;">
    <h2 style="margin: 0 0 8px 0; font-size: 28px; font-weight: bold; color: #f1f5f9;">Dashboard</h2>
    <p style="margin: 0; font-size: 14px; color: #94a3b8;">Your sales empire at a glance</p>
</div>

<!-- KPI Cards -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 40px;">
    <div class="card" style="padding: 24px; border-radius: 8px;">
        <div class="kpi-label">Revenue MTD</div>
        <div class="kpi-value">${{ revenue_mtd|floatformat:0|default:"0" }}</div>
        <div class="kpi-sub">This month's closed deals</div>
    </div>
    
    <div class="card" style="padding: 24px; border-radius: 8px;">
        <div class="kpi-label">Weighted Pipeline</div>
        <div class="kpi-value">${{ weighted_pipeline|floatformat:0|default:"0" }}</div>
        <div class="kpi-sub">Probability-weighted value</div>
    </div>
    
    <div class="card" style="padding: 24px; border-radius: 8px;">
        <div class="kpi-label">Closing This Week</div>
        <div class="kpi-value">{{ deals_closing_this_week }}</div>
        <div class="kpi-sub">Deals to close soon</div>
    </div>
    
    <div class="card" style="padding: 24px; border-radius: 8px;">
        <div class="kpi-label">Avg Deal Size</div>
        <div class="kpi-value">${{ avg_deal_size|floatformat:0|default:"0" }}</div>
        <div class="kpi-sub">Average deal value</div>
    </div>
</div>

<!-- Deals Table -->
<div class="card" style="border-radius: 8px; overflow: hidden;">
    <div style="padding: 24px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: #f1f5f9;">Active Deals</h3>
        <span style="font-size: 12px; color: #94a3b8;">{{ deals|length }} deal{{ deals|length|pluralize }}</span>
    </div>
    
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 1px solid #334155;">
                    <th style="padding: 16px; text-align: left; font-size: 12px; font-weight: 600; color: #94a3b8; text-transform: uppercase; background-color: #0f172a;">Company</th>
                    <th style="padding: 16px; text-align: left; font-size: 12px; font-weight: 600; color: #94a3b8; text-transform: uppercase; background-color: #0f172a;">Value</th>
                    <th style="padding: 16px; text-align: left; font-size: 12px; font-weight: 600; color: #94a3b8; text-transform: uppercase; background-color: #0f172a;">Stage</th>
                    <th style="padding: 16px; text-align: left; font-size: 12px; font-weight: 600; color: #94a3b8; text-transform: uppercase; background-color: #0f172a;">Next Action</th>
                    <th style="padding: 16px; text-align: left; font-size: 12px; font-weight: 600; color: #94a3b8; text-transform: uppercase; background-color: #0f172a;">Due</th>
                    <th style="padding: 16px; text-align: left; font-size: 12px; font-weight: 600; color: #94a3b8; text-transform: uppercase; background-color: #0f172a;">Owner</th>
                </tr>
            </thead>
            <tbody>
                {% for deal in deals %}
                <tr class="table-row" style="border-bottom: 1px solid #334155; cursor: pointer;" onclick="openSlideOver('{{ deal.id }}')">
                    <td style="padding: 16px; font-size: 14px; color: #f1f5f9;">
                        <div style="font-weight: 500;">{{ deal.contact.company }}</div>
                        <div style="font-size: 12px; color: #94a3b8;">{{ deal.contact.contact_name }}</div>
                    </td>
                    <td style="padding: 16px; font-size: 14px; font-weight: 600; color: #f59e0b;">
                        {% if deal.deal_value_usd %}${{ deal.deal_value_usd|floatformat:0 }}{% else %}â€”{% endif %}
                    </td>
                    <td style="padding: 16px;">
                        {% if deal.deal_stage == 'Closed Won' %}
                            <span class="badge badge-green">{{ deal.deal_stage }}</span>
                        {% elif deal.deal_stage == 'Negotiation' %}
                            <span class="badge badge-amber">{{ deal.deal_stage }}</span>
                        {% elif deal.deal_stage == 'Proposal' %}
                            <span class="badge badge-amber">{{ deal.deal_stage }}</span>
                        {% else %}
                            <span class="badge" style="background-color: rgba(148, 163, 184, 0.2); color: #cbd5e1;">{{ deal.deal_stage }}</span>
                        {% endif %}
                    </td>
                    <td style="padding: 16px; font-size: 14px; color: #cbd5e1;">{{ deal.next_action|default:"â€”"|truncatewords:4 }}</td>
                    <td style="padding: 16px; font-size: 14px;">
                        {% if deal.next_action_due %}
                            {% now "Y-m-d" as today_str %}
                            {% if deal.next_action_due|date:"Y-m-d" < today_str %}
                                <span class="badge badge-red">{{ deal.next_action_due|date:"M d" }} ðŸ”¥</span>
                            {% else %}
                                <span style="color: #cbd5e1;">{{ deal.next_action_due|date:"M d, Y" }}</span>
                            {% endif %}
                        {% else %}
                            <span style="color: #94a3b8;">â€”</span>
                        {% endif %}
                    </td>
                    <td style="padding: 16px; font-size: 14px; color: #f1f5f9;">You</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" style="padding: 40px; text-align: center; color: #94a3b8;">
                        <p style="margin: 0 0 16px 0;">No deals found. Create your first deal to start building your empire.</p>
                        <a href="{% url 'crm:deal_create' %}" style="background-color: #f59e0b; color: #000; padding: 8px 16px; border-radius: 4px; text-decoration: none; font-weight: 500; font-size: 14px; display: inline-block;">Create Deal</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% endblock %}
